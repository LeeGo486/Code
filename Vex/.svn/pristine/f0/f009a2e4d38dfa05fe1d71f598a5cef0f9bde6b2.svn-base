
$(document).ready(function(){
	initSearch();
	initLinkBtn();

	var url = GetWSRRURL('3a9cf88e-fc42-485d-9dff-96c35a8a1750')
		+ "&XML=" + GetGetJson([], 'getWXList');
	initDataGrid(url);
});



function initSearch(){
    $("#search").textbox({
		width:400,
		prompt:'请输入：维修单号或店铺名称',
		type:'text',
		buttonIcon:'icon-search',
		buttonText:'搜索',
		onClickButton:function(){search()}
    }).textbox('setValue',"");

    // when press ENTER key, accept the inputed value.
	$("#search").textbox('textbox')
		.bind('keydown', function(e){
			if (e.keyCode == 13){ 
			    search();
			};
	});
}

function search(){
	
	var wxno = $("#search").textbox('getValue');

	var url = GetWSRRURL('3a9cf88e-fc42-485d-9dff-96c35a8a1750');
	if(wxno.length == 0){
		url += "&XML=" + GetGetJson([], 'getWXList');
	}
	else{
		var isNum = isNaN(wxno);
		if(isNum){
			wxno = escape(wxno);
			url += "&XML=" + GetFormJson([{"name":"txtDepotName","value":wxno}], 'getWXList');
		}
		else{
			url += "&XML=" + GetFormJson([{"name":"txtWxno","value":wxno}], 'getWXList');
		};
		
	};

    initDataGrid(url);
}

function initDataGrid(url){
	$("#tab_list").datagrid({
		url:url,
        singleSelect: true,
        selectOnCheck: false,
        checkOnSelect: true,
        fit:false,
        striped:true,
        columns: [[
        	{ field: 'ck',checkbox:true},
            { field: 'wxno', title: '维修单号', width: 100 },
            { field: 'wxstname', title: '维修单类型', width: 70 },
            { field: 'sku', title: '维修款号', width: 100 },
            { field: 'statusname', title: '维修单状态', width: 75 },
			{ field: 'drname', title: '处理结果', width: 70 },
			{ field: 'question', title: '问题描述', width: 300 },
            { field: 'backdate', title: '退回日期', width: 100 },
            { field: 'respname', title: '店长姓名', width: 70 },
            { field: 'respphone', title: '店长电话', width: 100 },
            { field: 'staffname', title: '受理导购', width: 70 },
            { field: 'staffphone', title: '导购电话', width: 100 },
        ]],
        onClickRow:function(index,row){
        	//control button is enable or disable.
        	var rowStatus = row.status;
        	var rowRst = row.deciderst;
        	checkStatusAndRst(rowStatus,rowRst,index);

        },
        onDblClickRow:function(index,row){
        	// open tabs to fix detail info.
        	var wxno = row.wxno;
        	linkNewPage(wxno,"info");
        },
        onCheck:function(index,row){
        	//check row result and status.
        	var rowStatus = row.status;
        	var rowRst = row.deciderst;
        	checkStatusAndRst(rowStatus,rowRst,index);
        },
        pagination: true, //是否开启分页
        pageNumber: 1, //默认索引页
        pageSize: 20, //默认一页数据条数
	});

}

function initLinkBtn(){

	$("#again").linkbutton({
		iconCls:'icon-edit',
		plain:true,
		onClick:function(){
			alert("again");
		}
	});
	$("#accomplish").linkbutton({
		iconCls:'icon-ok',
		plain:true,
		onClick:function(){
			alert("accomplish");
		}
	});             
    $("#back").linkbutton({
    	iconCls:'icon-undo',
		plain:true,
		onClick:function(){
			alert("back");
		}
    });
}

function checkStatusAndRst(rowStatus,rowRst,rowindex){
	if(rowStatus == 60){
		$("#again").linkbutton('disable');
		$("#accomplish").linkbutton('disable');
		$("#tab_list").datagrid('uncheckRow',rowindex);
	}
	else if(rowStatus >= 45){
		$("#again").linkbutton('enable');
		$("#accomplish").linkbutton('disable');
		$("#tab_list").datagrid('uncheckRow',rowindex);
	}
	else if(rowStatus >= 40){
		$("#again").linkbutton('enable');
		$("#accomplish").linkbutton('disable');
	}
	else if(rowStatus <= 25){
		$("#tab_list").datagrid('uncheckRow',rowindex);
	}
	else{
		$("#again").linkbutton('enable');
		$("#accomplish").linkbutton('enable');
	};

	if(rowRst =="rst0"){
		$("#tab_list").datagrid('uncheckRow',rowindex);
	};
}

function linkNewPage(wxno,type){
	if(type == "info"){
		var url = "../../WEB/SPWX/SPWX_WXDetailInfo.html?wxno="+wxno;

		var content = "<iframe id=\"newWx\" scrolling=\"auto\" frameborder=\"0\" src=\""+url+"\"";
		content += " style=\"width:100%;height:95%\"></iframe>";

		window.parent.$("#mainTabs").tabs('add',{
       	title: '维修单明细信息',
        content: content,
        iconCls: 'icon-search',
        closable: true
    	});
	}
}