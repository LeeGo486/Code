<html>
<head>
    <meta http-equiv="content-type" content="text/html">  
    <meta charset="UTF-8">   
    <script src="../../../jquery-easyui-1.3.4/jquery-1.8.0.min.js" type="text/javascript"></script>
    <link id="easyuiTheme" href="../../../jquery-easyui-1.3.4/themes/ehras/easyui.css"
        rel="stylesheet" type="text/css" />

    <script src="../../../jquery-easyui-1.3.4/js_hzycfg.js" type="text/javascript"></script>
    <script src="../../../jquery-easyui-1.3.4/jquery.cookie.js" type="text/javascript"></script>
    <link id="Link1" href="../../../jquery-easyui-1.3.4/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <!--<script src="../../../jquery-easyui-1.3.4/changeEasyuiTheme.js" type="text/javascript"></script>-->
    <link href="../../../jquery-easyui-1.3.4/themes/icon.css" rel="stylesheet" type="text/css" />
    <script src="../../../jquery-easyui-1.3.4/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="../../../jquery-easyui-1.3.4/js_hzyCommon.js" type="text/javascript"></script>
    <script src="../../../jquery-easyui-1.3.4/jquery.ajaxupload.js" type="text/javascript"></script>
    <script src="../../../jquery-easyui-1.3.4/js.extend.datetime.js" type="text/javascript"></script>  

    <title>照片 </title>
    <script>
        $(function () {
            //return;
            $("#filepath").val('');
            //文件上传相关----------------- 
            var button = $('#btnUp'), interval;
            new AjaxUpload(button, {
                //action: 'upload-test.php',文件上传服务器端执行的地址
                //action: '/Handler_Upload.ashx?filePath=peoa',
                action: '../../../Handler_Upload.ashx?filePath=peoa',
                name: 'myfile',
                onSubmit: function (file, ext) { 
                    if (!(ext && /^(jpg|JPG|BMP|bmp|gif|GIF|PNG|png)$/.test(ext))) {
                        alert('图片格式不正确,请选择jpg,bmp,gif,png 格式的文件!', '系统提示');
                        return false;
                    }
                    button.val('文件上传中');
                    this.disable();
                    interval = window.setInterval(function () {
                        var text = button.val();
                        if (text.length < 10) {
                            button.val(text + '.');
                        } else {
                            button.val('文件上传中');
                        }
                    }, 200);
                },
                onComplete: function (file, response) {
                    //file 本地文件名称，response 服务器端传回的信
                    window.clearInterval(interval);
                    // enable upload button
                    this.enable();
                    var k = response.replace(/<pre.*>{/, "{").replace("</pre>", "").replace(/"<PRE.*>/, "").replace("</PRE>\"", "");

                    try {
                        var result = eval("[" + k + "]");
                        if (result[0].Error) {
                            $.messager.progress('close'); 
                            $.messager.alert("系统错误", result[0].Error, 'error');
                        }
                        else if (result[0].rows[0].result == "False") { 
                            $.messager.progress('close'); 
                            $.messager.alert("提示", result[0].rows[0].message, 'error');
                        }
                        else {
                            //button.val('上传成功！');
                            $("#filepath").val(result[0].rows[0].message);
                            var theFilePath = result[0].rows[0].message;
                            theFilePath = theFilePath.replace(/\//g, '\\');
                            //本地文件路径
                            //theFilePath = 'F:\\visual studio 2012\\01SrcCode2\\HTML' + theFilePath;
                            //104文件路径
                            //theFilePath = 'D:\\site\\HTML' + theFilePath;
                            //35文件路径
                            theFilePath = 'D:\\site\\PE_OA' + theFilePath; 
                            //alert(theFilePath);  
                            uploadfile1(theFilePath);
                        }
                    } catch (ex) {
                        $.messager.progress('close');
                        $.messager.alert("提示", ex, 'error');
                    }
                }
            });
        });

        function uploadfile() {
            document.getElementById("uploadfiles_on_file_selected").style.display = "none";
            document.getElementById("uploadfiles_is_not_pic").style.display = "none";
            if (document.getElementById('filepath').value.length == 0) {
                document.getElementById("uploadfiles_on_file_selected").style.display = '';
                return false;
            }
            var fobj = document.getElementById("filepath");
            fobj.select();
            window.top.document.body.focus();
            var theFilePath = document.selection.createRange().text;
            var fileType = theFilePath.substr(theFilePath.lastIndexOf(".") + 1);
            fileType = fileType.toUpperCase();
            if (fileType != "PNG" && fileType != "GIF" && fileType != "JPG"
                    && fileType != "JPEG" && fileType != "BMP") {
                document.getElementById("uploadfiles_is_not_pic").style.display = '';
                return false;
            }
            uploadfile1(theFilePath);
        }


        function uploadfile1(filepath) {
            //57/114文件路径
            var theFilePathnew = "D:\\peoa\\" + filepath.substr(filepath.lastIndexOf("\\") + 1);
            var curl = '../../../Handler_Uploadpeoa.ashx?filePath=' + encodeURIComponent(filepath); // 拼接url  
            //alert(theFilePathnew);
            $.ajax({
                url: curl,
                type: "GET",
                async: false,
                dataType: "json",
                success: function (data) {
                    if (data && data.res) {
                        if (data.res.toUpperCase() == 'OK') {
                            parent.uploadfile("B", theFilePathnew);
                        }
                    }
                }
            });
            return true;
        }
    </script>
</head>
<body>
    <div id="tbPageTopShell">
        <div id="tbPageTop">
            <br />
        </div>
        <div id="tbTips">
            <em>单击“浏览”选择一个需上传的照片即可上传！</em>
        </div>
    </div>
    <form name="uploadForm">

        <input type="text" style="height: 26px; width: 450px;" id="filepath" name="filepath"
            value="" onkeypress="return false;" contenteditable="false" />

        <input type="button" id="btnUp" value="浏览" />
       <!-- <input type="file" style="height: 20px; width: 450px;" id="filepath" name="filepath"
            value="" onkeypress="return false;" contenteditable="false" />
        <input type="button" name="upload" style="height: 20px" value="确定" onclick="javascript: uploadfile();" />-->
        <br />
        <span id="uploadfiles_on_file_selected" style="display: none; color: red;">请选择文件</span>
        <span id="uploadfiles_is_not_pic" style="display: none; color: red;">请选择图片文件</span>
    </form>
</body>
</html>
