$().ready(function(){getUserInfo();$("#login").click(login)});function login(){var lgData=$("#loginForm").serializeArray();if(lgData[0].value==""||lgData[1].value==""){$("#login").popover({"html":true,"placement":"bottom","content":"请输入完整!","delay":{"show":500,"hide":100}});return}$.ajax({async:true,cache:false,type:"POST",dataType:"json",url:GetLoginURL(),data:lgData,error:function(){alert(GetErrorMsg("E0001"))},onSubmit:function(){},success:function(data){if(data!=null&&data.Result!=null){$.ajax({url:GetLoginNameURL(),options:"JSON",success:function(data){if(eval("["+data+"]")[0].Error){alert("出错了",eval("["+data+"]")[0].Error);return}var user=eval("["+data+"]")[0].UserName;window.m_UserID=user;if(user&&user!=""){crtLogMsg(user);checkCarNum()}else{alert("已过期，请重新登录");return}}})}else{if(data!=null&&data.Error!=null){alert(data.Error);return}}}})}function getUserInfo(){if(window.m_UserID==""){return}$.ajax({url:GetLoginNameURL(),options:"JSON",success:function(data){if(eval("["+data+"]")[0].Error){alert("出错了",eval("["+data+"]")[0].Error,"error");return}var user=eval("["+data+"]")[0].UserName;window.m_UserID=user;if(user&&user!=""){crtLogMsg(user);checkCarNum()}else{alert("已过期，请重新登录");return}}})}function crtLogMsg(){var a='<ul class="nav nav-pills msg-list left">';a+="<li>";a+="<span>";a+='<i class="icon-user"></i><span style="font-size: 12px;">您好,'+arguments[0]+"</span>";a+='<a id="exit" href="#"><span style="font-size: 12px;">[退出]</span></a>';a+="</span>";a+="</li>";a+="<li>";a+='<span><i class="icon-gift"></i>';a+='<span id="Credits" style="font-size: 12px;">积分：0</span>';a=="</span>";a+="</li>";a+="<li>";a+="<span>";a+='<a id="shpCar" href="ShoppingCar.html">';a+='<span id="CarCount" href="#" style="font-size:1.2em;" ><i class="icon-shopping-cart icon-2x"></i>购物车：0</span></a>';a+="</span>";a+="</li>";a+="</ul>";$("#loginForm").html("");$("#loginMsg").html("").html(a);$("#exit").unbind("click").click(exitUser)}function exitUser(){window.m_UserID="";Logout();$("#loginMsg").html("");var a='<input class="input-small" type="text" ';a+='name="UserName" placeholder="员工号">';a+='<input class="input-small" type="password" ';a+='name="Password" placeholder="密码" >';a+='<a class="btn btn-small" id="login">登陆</a>';$("#loginForm").html("").html(a);$("#login").unbind("click").click(login)}function Logout(){$.ajax({async:true,cache:false,type:"POST",dataType:"json",url:GetWSRRURL("f5f35aca-469b-463c-b33c-2e872dabbec3"),error:function(){alert(GetErrorMsg("E0001"))},success:function(a){if(a.Result!=null){window.location="../PresentOutSide/Goods.html"}else{if(a.Error!=null){alert(a.Error)}}}})}function checkCarNum(){if(window.m_UserID==""){return}var XMLData=GetFormJson([],"CarNum");$.post(GetWSRRURL("7fafd6d1-c1ae-4625-97e7-2c58282d7147")+"&XML="+XMLData,function(result){var result=eval("["+result+"]");if(result[0].Error){alert("系统错误",result[0].Error)}else{if(result[0].rows[0].result=="False"){alert("提示",result[0].rows[0].message)}else{if(result[0].rows[0].num==""){result[0].rows[0].num="0"}if(result[0].rows[0].credits==""){result[0].rows[0].credits="0"}$("#CarCount").html("").html('<i class="icon-shopping-cart"></i>购物车：'+result[0].rows[0].num);$("#Credits").html("").html("积分："+result[0].rows[0].credits);return}}})}function checkLogin(){if(window.m_UserID==""){alert("请先用员工号登录");$("input[name=UserName]").focus();return false}return true};