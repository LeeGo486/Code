<script type="text/javascript">
    $(function () {
        $('#calendar').fullCalendar({
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,basicWeek,basicDay'
            },
            monthNames: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
            monthNamesShort: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
            dayNames: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"],
            dayNamesShort: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"],
            today: ["今天"],
            firstDay: 1,
            buttonText: {
                today: '今天',
                month: '月',
                week: '周',
                day: '日'
            },
            titleFormat: {
                month: 'MMMM',
                week: "MMMM",
                day: 'MMMM'
            },
            weekMode: "liquid",
            events: function (start, end, callback) {
                $.post("/S3/Calendar/Get?sid=" + Url.get("sid") + "&oid=" + Url.get("oid") + "&start=" + start.format("YYYY-MM-DD") + "&end=" + end.format("YYYY-MM-DD"), function (data) {
                    for (var i = 0; i < data.length; i++) {
                        var ev = data[i];

                        var obj = new Object();
                        obj.title = ev.Name;
                        obj.start = new Date(parseInt(ev.EventDay.replace(/\D/igm, "")) + 1);
                        obj.global = ev.Global;
                        obj.plan = ev.PlanNum;
                        obj.respond = ev.RespondNum;
                        obj.fact = ev.FactNum;
                        obj.buy = ev.BuyNum;
                        obj.price = ev.Price;
                        obj.id = 1;

                        $('#calendar').fullCalendar('renderEvent', obj);
                    }
                });
            },
            dayClick: function (date, allDay, jsEvent, view) {
                loadDetail(date.format("YYYY-MM-DD"));
            },
            eventClick: function (event) {
                loadDetail(event.start.format("YYYY-MM-DD"));
            },
            loading: function (bool) {
                if (bool) $('#loading').show();
                else $('#loading').hide();
            },
            eventMouseover: function (calEvent, jsEvent, view) {
                $(this).attr('title', calEvent.EventDay);
                $(this).css('font-weight', 'normal');
                $(this).tooltip({
                    effect: 'toggle',
                    cancelDefault: true
                });
            },
            eventMouseout: function (calEvent, jsEvent, view) {
                $(this).css('font-weight', 'normal');
            },
            eventAfterRender: function (event, element, view) {
                var fstart = event.EventDay;
                var confbg = '';
                var confbg = confbg + '<span class="fc-event-bg"></span>';
                var titlebg = '<span class="fc-event-conf">' + event.title + '</span>';

                if (view.name == "month") {
                    var evtcontent = '<div class="fc-event-vert">';
                    evtcontent = evtcontent + confbg;
                    evtcontent = evtcontent + '<span style="color:#D96B27;">' + event.respond + '</span>/';
                    evtcontent = evtcontent + '<span style="color:#4181BB;">' + event.plan + '</span></br>';
                    evtcontent = evtcontent + '<span style="color:#00A44A;">' + event.buy + '</span>/';
                    evtcontent = evtcontent + '<span style="color:#7030A0;">' + event.fact + '</span></br>';
                    evtcontent = evtcontent + '<div class="ui-resizable-handle ui-resizable-e"></div></div>';
                    element.html(evtcontent);
                } else if (view.name == "basicWeek") {
                    var evtcontent = '<div class="fc-event-vert">';
                    evtcontent = evtcontent + confbg;
                    evtcontent = evtcontent + '<span class="fc-event-titlebg">' + titlebg + '</span></br></br>';
                    evtcontent = evtcontent + '<span>预约: <span style="color:#4181BB;">' + event.plan + '</span></span></br>';
                    evtcontent = evtcontent + '<span>应邀: <span style="color:#D96B27;">' + event.respond + '</span></span></br>';
                    evtcontent = evtcontent + '<span>到店: <span style="color:#7030A0;">' + event.fact + '</span></span></br>';
                    evtcontent = evtcontent + '<span>购买: <span style="color:#00A44A;">' + event.buy + '</span></span></br>';
                    evtcontent = evtcontent + '<div class="ui-resizable-handle ui-resizable-e"></div></div>';
                    element.html(evtcontent);
                } else if (view.name == "basicDay") {
                    var evtcontent = '<div class="fc-event-vert">';
                    evtcontent = evtcontent + confbg;
                    evtcontent = evtcontent + '<span class="fc-event-titlebg">' + titlebg + '</span></br></br>';
                    evtcontent = evtcontent + '<span>目标: ' + event.global + '</span></br>';
                    evtcontent = evtcontent + '<span>预约: <span style="color:#4181BB;">' + event.plan + '</span></span></br>';
                    evtcontent = evtcontent + '<span>应邀: <span style="color:#D96B27;">' + event.respond + '</span></span></br>';
                    evtcontent = evtcontent + '<span>到店: <span style="color:#7030A0;">' + event.fact + '</span></span></br>';
                    evtcontent = evtcontent + '<span>购买: <span style="color:#00A44A;">' + event.buy + '</span></br>';
                    evtcontent = evtcontent + '<span>金额: ' + event.price + '</span></br>';
                    evtcontent = evtcontent + '<div class="ui-resizable-handle ui-resizable-e"></div></div>';
                    element.html(evtcontent);
                }
            }
        });

        $('#calendar').fullCalendar('changeView', "basicWeek");
    });

    //加载活动明细
    function loadDetail(eventday) {
        Msg.show("活动明细加载中...", 3);
        $.get("/S3/Calendar/Detail?sid=" + Url.get("sid") + "&oid=" + Url.get("oid"), {eventday: eventday}, function (htmldata) {
            Msg.hide();
            showDetail(htmldata);
            $(".seDate").val(eventday);
        });
    }

    //显示活动明细
    function showDetail(data) {
        $("#sdetailarea").html(data);
        scrollTo("#sdetailarea");
    }

    //提交活动明细
    function submitDetail(data) {
        //构造提交json的格式
        var paramData = {
            Theme: $(".seTheme option:selected").val(),
            Name: $(".seTheme option:selected").text(),
            Global: $(".seGlobal").val(),
            PlanNum: $(".sePlan").val(),
            RespondNum: $(".seRespond").val(),
            FactNum: $(".seFact").val(),
            BuyNum: $(".seBuy").val(),
            Price: $(".sePrice").val(),
            EventDay: $(".seDate").val()
        };

        Msg.show("提交中...", 3);
        $.post("/S3/Calendar/SubmitEvent?sid=" + Url.get("sid") + "&oid=" + Url.get("oid"), paramData, function (rst) {
            Msg.hide();
            Msg.show(rst.msg, rst.result);
            if (rst.result == 0) {
                $('#sdetailarea div').fadeOut(1000);

                var obj = new Object();
                obj.title = paramData.Name;
                obj.start = paramData.EventDay;
                obj.global = paramData.Global;
                obj.plan = paramData.PlanNum;
                obj.respond = paramData.RespondNum;
                obj.fact = paramData.FactNum;
                obj.buy = paramData.BuyNum;
                obj.price = paramData.Price;
                obj.id = 1;

                $('#calendar').fullCalendar('renderEvent', obj);
            }
                
        });
    }

    //修改活动明细
    function updateDetail(data) {
        //构造提交json的格式
        var paramData = {
            Id: $(".seId").val(),
            Theme: $(".seTheme option:selected").val(),
            Name: $(".seTheme option:selected").text(),
            Global: $(".seGlobal").val(),
            PlanNum: $(".sePlan").val(),
            RespondNum: $(".seRespond").val(),
            FactNum: $(".seFact").val(),
            BuyNum: $(".seBuy").val(),
            Price: $(".sePrice").val(),
            EventDay: $(".seDate").val()
        };

        Msg.show("提交中...", 3);
        $.post("/S3/Calendar/UpdateEvent?sid=" + Url.get("sid") + "&oid=" + Url.get("oid"), paramData, function (rst) {
            Msg.hide();
            Msg.show(rst.msg, rst.result);
            if (rst.result == 0) {
                $('#sdetailarea div').fadeOut(1000);

                var obj = new Object();
                obj.title = paramData.Name;
                obj.start = paramData.EventDay;
                obj.global = paramData.Global;
                obj.plan = paramData.PlanNum;
                obj.respond = paramData.RespondNum;
                obj.fact = paramData.FactNum;
                obj.buy = paramData.BuyNum;
                obj.price = paramData.Price;
                obj.id = 1;

                $('#calendar').fullCalendar('refetchEvents');
            }  
        });
    }
</script>

<div class="ht" id="scalendar">
    <i class="icon-calendar"></i>&nbsp;&nbsp;活动反馈
    <span onclick="Msg.show('分享到社区',0);">
        <i class="icon-random icon-large"></i>
    </span>
    <span onclick="Msg.show('分享给店长',0);">
        <i class="icon-signin icon-large"></i>
    </span>
</div>

<div class="dataDetail">
    <div id="calendar"></div>
    <div style="margin-top:10px;">
        <span>
            <span style="background-color:#D96B27;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
            <span>应邀人数</span>
        </span>
        <span>
            <span style="background-color:#4181BB;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
            预约人数
        </span>
    </div>
    <div style="margin-top:10px;">
        <span>
            <span style="background-color:#00A44A;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
            购买人数
        </span>
        <span>
            <span style="background-color:#7030A0;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
            到店人数
        </span>
    </div>
    <div id="sdetailarea">
    </div>
</div>